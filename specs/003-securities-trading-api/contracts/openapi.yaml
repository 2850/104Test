openapi: 3.0.3
info:
  title: 證券交易資料查詢系統 API
  description: |
    提供台灣證券交易所股票查詢、即時報價、委託下單與查詢功能。
    
    ## 功能範圍 (MVP)
    - 股票代號查詢與驗證
    - 股票即時報價查詢
    - 委託單建立
    - 委託單查詢
    
    ## 速率限制
    - 每個客戶端 IP 位址每秒最多 10 次請求
    - 超過限制將回傳 HTTP 429 (Too Many Requests)
    
    ## 錯誤處理
    - 所有錯誤回應遵循 RFC 7807 ProblemDetails 標準
    - 錯誤訊息使用繁體中文
    
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:5000/api/v1
    description: 本地開發環境
  - url: https://api-staging.example.com/api/v1
    description: 測試環境
  - url: https://api.example.com/api/v1
    description: 正式環境

tags:
  - name: Stocks
    description: 股票查詢相關 API
  - name: Orders
    description: 委託單相關 API

paths:
  /stocks/{stockCode}:
    get:
      tags:
        - Stocks
      summary: 查詢股票基本資訊
      description: |
        根據股票代號查詢股票基本資訊，包含公司名稱、簡稱、交易所、產業別等。
        
        **User Story**: P1 - 股票代號查詢
        **功能需求**: FR-001, FR-002, FR-003
      operationId: getStockInfo
      parameters:
        - name: stockCode
          in: path
          description: 股票代號（4 位數字，如 "2330"）
          required: true
          schema:
            type: string
            pattern: '^\d{4}$'
            example: "2330"
      responses:
        '200':
          description: 成功取得股票資訊
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StockInfoResponse'
              examples:
                tsmc:
                  summary: 台積電範例
                  value:
                    stockCode: "2330"
                    stockName: "台灣積體電路製造股份有限公司"
                    stockNameShort: "台積電"
                    exchange: "TWSE"
                    industry: "半導體"
        '400':
          description: 請求參數驗證錯誤
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ValidationProblemDetails'
              example:
                type: "https://tools.ietf.org/html/rfc7231#section-6.5.1"
                title: "驗證錯誤"
                status: 400
                detail: "請求包含無效的參數"
                instance: "/api/stocks/ABC"
                traceId: "00-1234567890abcdef-1234567890abcdef-00"
                errors:
                  stockCode:
                    - "股票代號格式錯誤，必須為 4 位數字"
        '404':
          description: 股票代號不存在
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://tools.ietf.org/html/rfc7231#section-6.5.4"
                title: "資源不存在"
                status: 404
                detail: "股票代號不存在"
                instance: "/api/stocks/9999"
                traceId: "00-1234567890abcdef-1234567890abcdef-00"
        '429':
          description: 請求次數過多
          headers:
            Retry-After:
              description: 建議重試等待時間（秒）
              schema:
                type: integer
                example: 1
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RateLimitProblemDetails'

  /stocks/{stockCode}/quote:
    get:
      tags:
        - Stocks
      summary: 查詢股票即時報價
      description: |
        查詢特定股票的即時報價資訊，包含最新成交價、開盤價、最高價、最低價、昨收價、漲跌停價格、成交量等。
        
        資料來源：台灣證券交易所官方即時報價 API（透過 InMemory Cache 快取 5 秒）
        
        **User Story**: P2 - 查詢單一股票即時價格
        **功能需求**: FR-004, FR-005, FR-006, FR-007, FR-008
      operationId: getStockQuote
      parameters:
        - name: stockCode
          in: path
          description: 股票代號（4 位數字）
          required: true
          schema:
            type: string
            pattern: '^\d{4}$'
            example: "2330"
      responses:
        '200':
          description: 成功取得股票即時報價
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StockQuoteResponse'
              examples:
                tsmc:
                  summary: 台積電即時報價範例
                  value:
                    stockCode: "2330"
                    stockName: "台積電"
                    currentPrice: 975.00
                    yesterdayPrice: 950.00
                    openPrice: 955.00
                    highPrice: 980.00
                    lowPrice: 945.00
                    limitUpPrice: 1045.00
                    limitDownPrice: 855.00
                    changeAmount: 25.00
                    changePercent: 2.63
                    totalVolume: 52342000
                    totalValue: 50832615000.00
                    updateTime: "2026-02-02T13:30:00Z"
        '400':
          description: 請求參數驗證錯誤
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ValidationProblemDetails'
        '404':
          description: 股票代號不存在
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '429':
          description: 請求次數過多
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RateLimitProblemDetails'
        '503':
          description: 外部資料來源無法取得
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ExternalApiProblemDetails'
              example:
                type: "https://tools.ietf.org/html/rfc7231#section-6.5.3"
                title: "外部服務錯誤"
                status: 503
                detail: "無法取得即時資料，請稍後再試"
                instance: "/api/stocks/2330/quote"
                traceId: "00-1234567890abcdef-1234567890abcdef-00"

  /orders:
    post:
      tags:
        - Orders
      summary: 建立委託單
      description: |
        建立股票買賣委託單，系統將驗證股票代號、價格範圍、數量單位等。
        
        **驗證規則**:
        - 股票代號必須存在
        - 委託價格必須在當日漲跌停範圍內
        - 委託數量必須為 1000 股的整數倍（整股交易）
        - 買賣別必須為 1（買進）或 2（賣出）
        
        **User Story**: P3 - 建立委託單
        **功能需求**: FR-009 ~ FR-017
      operationId: createOrder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
            examples:
              buyOrder:
                summary: 買進委託範例
                value:
                  userId: 1
                  stockCode: "2330"
                  orderType: 1
                  price: 975.00
                  quantity: 1000
              sellOrder:
                summary: 賣出委託範例
                value:
                  userId: 1
                  stockCode: "2330"
                  orderType: 2
                  price: 980.00
                  quantity: 2000
      responses:
        '201':
          description: 委託單建立成功
          headers:
            Location:
              description: 新建立的委託單 URI
              schema:
                type: string
                example: "/api/orders/123456789"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateOrderResponse'
              example:
                orderId: 123456789
                orderSeq: 20260202000001
                message: "委託單建立成功"
        '400':
          description: 請求參數驗證錯誤
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ValidationProblemDetails'
              examples:
                invalidStockCode:
                  summary: 股票代號不存在
                  value:
                    type: "https://tools.ietf.org/html/rfc7231#section-6.5.1"
                    title: "驗證錯誤"
                    status: 400
                    detail: "請求包含無效的參數"
                    instance: "/api/orders"
                    traceId: "00-1234567890abcdef-1234567890abcdef-00"
                    errors:
                      stockCode:
                        - "股票代號不存在"
                invalidQuantity:
                  summary: 數量不符合整股交易
                  value:
                    type: "https://tools.ietf.org/html/rfc7231#section-6.5.1"
                    title: "驗證錯誤"
                    status: 400
                    detail: "請求包含無效的參數"
                    instance: "/api/orders"
                    traceId: "00-1234567890abcdef-1234567890abcdef-00"
                    errors:
                      quantity:
                        - "委託數量必須為 1000 股的整數倍（整股交易），您輸入的數量為 500 股"
                priceOutOfRange:
                  summary: 價格超出漲跌停範圍
                  value:
                    type: "https://tools.ietf.org/html/rfc7231#section-6.5.1"
                    title: "驗證錯誤"
                    status: 400
                    detail: "請求包含無效的參數"
                    instance: "/api/orders"
                    traceId: "00-1234567890abcdef-1234567890abcdef-00"
                    errors:
                      price:
                        - "委託價格超出漲跌停範圍"
        '429':
          description: 請求次數過多
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RateLimitProblemDetails'
        '503':
          description: 外部資料來源無法取得（無法驗證價格）
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ExternalApiProblemDetails'

  /orders/{orderId}:
    get:
      tags:
        - Orders
      summary: 查詢委託單
      description: |
        根據委託單編號查詢委託單詳細資訊。
        
        **User Story**: P4 - 查詢委託單
        **功能需求**: FR-018, FR-019, FR-020
      operationId: getOrder
      parameters:
        - name: orderId
          in: path
          description: 委託單編號
          required: true
          schema:
            type: integer
            format: int64
            example: 123456789
      responses:
        '200':
          description: 成功取得委託單資訊
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              example:
                orderId: 123456789
                orderSeq: 20260202000001
                userId: 1
                stockCode: "2330"
                stockName: "台積電"
                orderTypeName: "買進"
                price: 975.00
                quantity: 1000
                filledQuantity: 0
                orderStatusName: "已委託"
                createdAt: "2026-02-02T09:00:00Z"
        '404':
          description: 委託單不存在
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://tools.ietf.org/html/rfc7231#section-6.5.4"
                title: "資源不存在"
                status: 404
                detail: "委託單不存在：999999999"
                instance: "/api/orders/999999999"
                traceId: "00-1234567890abcdef-1234567890abcdef-00"
        '429':
          description: 請求次數過多
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/RateLimitProblemDetails'

components:
  schemas:
    # ===== 回應物件 =====
    StockInfoResponse:
      type: object
      required:
        - stockCode
        - stockName
        - stockNameShort
        - exchange
      properties:
        stockCode:
          type: string
          pattern: '^\d{4}$'
          description: 股票代號
          example: "2330"
        stockName:
          type: string
          maxLength: 100
          description: 公司名稱
          example: "台灣積體電路製造股份有限公司"
        stockNameShort:
          type: string
          maxLength: 50
          description: 公司簡稱
          example: "台積電"
        exchange:
          type: string
          enum: [TWSE, TPEX]
          description: 交易所（TWSE=上市, TPEX=上櫃）
          example: "TWSE"
        industry:
          type: string
          maxLength: 50
          description: 產業別
          example: "半導體"
          nullable: true

    StockQuoteResponse:
      type: object
      required:
        - stockCode
        - stockName
        - currentPrice
        - yesterdayPrice
        - openPrice
        - highPrice
        - lowPrice
        - limitUpPrice
        - limitDownPrice
        - changeAmount
        - changePercent
        - totalVolume
        - updateTime
      properties:
        stockCode:
          type: string
          description: 股票代號
          example: "2330"
        stockName:
          type: string
          description: 股票名稱
          example: "台積電"
        currentPrice:
          type: number
          format: decimal
          minimum: 0
          description: 最新成交價
          example: 975.00
        yesterdayPrice:
          type: number
          format: decimal
          minimum: 0
          description: 昨收價
          example: 950.00
        openPrice:
          type: number
          format: decimal
          minimum: 0
          description: 開盤價
          example: 955.00
        highPrice:
          type: number
          format: decimal
          minimum: 0
          description: 最高價
          example: 980.00
        lowPrice:
          type: number
          format: decimal
          minimum: 0
          description: 最低價
          example: 945.00
        limitUpPrice:
          type: number
          format: decimal
          minimum: 0
          description: 漲停價
          example: 1045.00
        limitDownPrice:
          type: number
          format: decimal
          minimum: 0
          description: 跌停價
          example: 855.00
        changeAmount:
          type: number
          format: decimal
          description: 漲跌金額
          example: 25.00
        changePercent:
          type: number
          format: decimal
          description: 漲跌幅 (%)
          example: 2.63
        totalVolume:
          type: integer
          format: int64
          minimum: 0
          description: 當日累積成交量（股）
          example: 52342000
        totalValue:
          type: number
          format: decimal
          minimum: 0
          description: 當日累積成交金額（元）
          example: 50832615000.00
          nullable: true
        updateTime:
          type: string
          format: date-time
          description: 最後更新時間（UTC）
          example: "2026-02-02T13:30:00Z"

    CreateOrderRequest:
      type: object
      required:
        - userId
        - stockCode
        - orderType
        - price
        - quantity
      properties:
        userId:
          type: integer
          format: int32
          description: 使用者編號（MVP 固定 1）
          example: 1
          default: 1
        stockCode:
          type: string
          pattern: '^\d{4}$'
          description: 股票代號（4 位數字）
          example: "2330"
        orderType:
          type: integer
          format: int32
          enum: [1, 2]
          description: 買賣別（1=買進, 2=賣出）
          example: 1
        price:
          type: number
          format: decimal
          minimum: 0.01
          description: 委託價格（必須在漲跌停範圍內）
          example: 975.00
        quantity:
          type: integer
          format: int32
          minimum: 1000
          multipleOf: 1000
          description: 委託數量（必須為 1000 股的整數倍）
          example: 1000

    CreateOrderResponse:
      type: object
      required:
        - orderId
        - orderSeq
        - message
      properties:
        orderId:
          type: integer
          format: int64
          description: 委託單編號
          example: 123456789
        orderSeq:
          type: integer
          format: int64
          description: 委託序號（YYYYMMDD + 6位流水號）
          example: 20260202000001
        message:
          type: string
          description: 回應訊息
          example: "委託單建立成功"

    OrderResponse:
      type: object
      required:
        - orderId
        - orderSeq
        - userId
        - stockCode
        - stockName
        - orderTypeName
        - price
        - quantity
        - filledQuantity
        - orderStatusName
        - createdAt
      properties:
        orderId:
          type: integer
          format: int64
          description: 委託單編號
          example: 123456789
        orderSeq:
          type: integer
          format: int64
          description: 委託序號
          example: 20260202000001
        userId:
          type: integer
          format: int32
          description: 使用者編號
          example: 1
        stockCode:
          type: string
          description: 股票代號
          example: "2330"
        stockName:
          type: string
          description: 股票名稱（反正規化）
          example: "台積電"
        orderTypeName:
          type: string
          enum: ["買進", "賣出"]
          description: 買賣別名稱
          example: "買進"
        price:
          type: number
          format: decimal
          description: 委託價格
          example: 975.00
        quantity:
          type: integer
          format: int32
          description: 委託數量
          example: 1000
        filledQuantity:
          type: integer
          format: int32
          description: 已成交數量（MVP 固定 0）
          example: 0
        orderStatusName:
          type: string
          description: 委託狀態名稱（MVP 固定 "已委託"）
          example: "已委託"
        createdAt:
          type: string
          format: date-time
          description: 建立時間（UTC）
          example: "2026-02-02T09:00:00Z"

    # ===== 錯誤回應物件 (RFC 7807 ProblemDetails) =====
    ProblemDetails:
      type: object
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
          description: 錯誤類型 URI
          example: "https://tools.ietf.org/html/rfc7231#section-6.5.4"
        title:
          type: string
          description: 錯誤標題（簡短摘要）
          example: "資源不存在"
        status:
          type: integer
          format: int32
          description: HTTP 狀態碼
          example: 404
        detail:
          type: string
          description: 錯誤詳細說明
          example: "股票代號不存在"
        instance:
          type: string
          format: uri
          description: 發生錯誤的 API 端點
          example: "/api/stocks/9999"
        traceId:
          type: string
          description: 追蹤識別碼（用於日誌查詢）
          example: "00-1234567890abcdef-1234567890abcdef-00"

    ValidationProblemDetails:
      allOf:
        - $ref: '#/components/schemas/ProblemDetails'
        - type: object
          required:
            - errors
          properties:
            errors:
              type: object
              description: 欄位驗證錯誤清單（Key- 欄位名稱, Value-錯誤訊息陣列）
              additionalProperties:
                type: array
                items:
                  type: string
              example:
                stockCode:
                  - "股票代號格式錯誤，必須為 4 位數字"
                quantity:
                  - "委託數量必須大於 0"
                  - "委託數量必須為 1000 股的整數倍"

    RateLimitProblemDetails:
      allOf:
        - $ref: '#/components/schemas/ProblemDetails'
        - type: object
          properties:
            retryAfter:
              type: string
              description: 建議重試等待時間
              example: "1 秒"
          example:
            type: "https://tools.ietf.org/html/rfc7231#section-6.5.1"
            title: "請求次數過多"
            status: 429
            detail: "您已超過速率限制（每秒 10 次請求），請稍後再試"
            instance: "/api/stocks/2330/quote"
            traceId: "00-1234567890abcdef-1234567890abcdef-00"
            retryAfter: "1 秒"

    ExternalApiProblemDetails:
      allOf:
        - $ref: '#/components/schemas/ProblemDetails'
        - type: object
          example:
            type: "https://tools.ietf.org/html/rfc7231#section-6.5.3"
            title: "外部服務錯誤"
            status: 503
            detail: "無法取得即時資料，請稍後再試"
            instance: "/api/stocks/2330/quote"
            traceId: "00-1234567890abcdef-1234567890abcdef-00"

  securitySchemes: {}

# MVP 階段不實作認證授權
security: []
