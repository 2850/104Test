# 功能規格：證券交易資料查詢系統

**功能分支**: `003-securities-trading-api`  
**建立日期**: 2026-02-02  
**狀態**: 草稿  
**輸入**: 實作證券交易資料查詢系統RESTful API，包含股票查詢、下單、委託查詢等功能

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - 股票代號查詢 (優先級: P1)

身為平台使用者，我需要能夠查詢股票代號是否存在，以確保我要查詢或交易的股票是有效的。

**為何此優先級**: 這是所有後續功能的基礎，若無法驗證股票代號的有效性，將導致後續查詢和交易功能產生錯誤。此功能必須優先實作。

**獨立測試**: 可透過輸入有效或無效的股票代號來完全獨立測試，並驗證系統回傳正確的存在性結果，無需依賴其他功能。

**驗收情境**:

1. **Given** 系統已載入台灣證券交易所股票清單，**When** 使用者輸入有效股票代號（如 "2330"），**Then** 系統回傳該股票存在，並顯示完整公司資訊（代號、名稱、簡稱）
2. **Given** 系統已載入台灣證券交易所股票清單，**When** 使用者輸入不存在的股票代號（如 "9999"），**Then** 系統回傳明確錯誤訊息「股票代號不存在」
3. **Given** 使用者輸入無效格式，**When** 使用者輸入非數字或過長的代號，**Then** 系統回傳格式驗證錯誤訊息

**備註**：關鍵字模糊查詢功能（如輸入「台積」查詢所有符合股票）為 MVP 後續增強功能，第一版暫不實作

---

### 使用者故事 2 - 查詢單一股票即時價格 (優先級: P2)

身為平台使用者，我需要查詢特定股票的即時價格和交易資訊，以便做出交易決策。

**為何此優先級**: 這是交易決策的核心資訊來源，使用者需要即時價格來決定是否下單及下單價格。此功能依賴股票代號驗證（P1），因此為第二優先。

**獨立測試**: 在 P1 完成後，可獨立測試此功能，輸入已驗證的股票代號，驗證系統是否正確呼叫外部 API 並回傳完整的即時交易資訊。

**驗收情境**:

1. **Given** 使用者已確認股票代號有效（如 "2330"），**When** 使用者查詢該股票即時資訊，**Then** 系統回傳最新成交價、成交量、開盤價、最高價、最低價、昨收價、五檔買賣價量、漲跌停價格等完整資訊
2. **Given** 股票市場已收盤，**When** 使用者查詢股票資訊，**Then** 系統回傳最後交易時段的資訊，並標示資料時間戳記
3. **Given** 外部 API 回應異常或逾時，**When** 使用者查詢股票資訊，**Then** 系統回傳明確錯誤訊息「無法取得即時資料，請稍後再試」，並記錄錯誤日誌
4. **Given** 使用者查詢停牌股票（如暫停交易中的股票），**When** 系統從外部 API 接收到無交易資料回應，**Then** 系統回傳 HTTP 200 狀態碼及「該股票目前停牌或無交易資料」訊息

**測試說明 - 快取策略驗證**：雖然 MVP 階段的驗收測試著重於功能正確性，但快取策略（research.md 中定義）將在整合測試階段驗證，包括：(1) 首次查詢應呼叫外部 API，(2) 5 秒內重複查詢同一股票應返回快取資料且回應時間 <100ms，(3) 快取過期後再次查詢應重新呼叫外部 API。

---

### 使用者故事 3 - 建立委託單 (優先級: P3)

身為平台使用者，我需要能夠建立股票買賣委託單，以執行交易決策。

**為何此優先級**: 這是核心交易功能，但必須在完成股票驗證（P1）和價格查詢（P2）後才能確保委託單的價格和標的合法性。

**獨立測試**: 在 P1、P2 完成後，可獨立測試委託單建立功能，包括輸入驗證、價格檢查、資料儲存等，並驗證系統正確回應成功或失敗訊息。

**驗收情境**:

1. **Given** 使用者已查詢股票即時資訊（如 "2330" 漲停價 1000 元、跌停價 800 元），**When** 使用者建立買入委託單（股票代號 "2330"、限價 950 元、數量 1000 股、買進），**Then** 系統驗證價格在漲跌停範圍內，成功建立委託單並回傳委託單編號
2. **Given** 使用者輸入委託資訊，**When** 使用者輸入的價格高於漲停價或低於跌停價（如 1050 元或 750 元），**Then** 系統拒絕建立委託單，並回傳「價格超出漲跌停範圍」錯誤訊息
3. **Given** 使用者輸入委託資訊，**When** 使用者輸入非整數倍數量（如 500 股，非 1000 股整數倍），**Then** 系統拒絕建立委託單，並回傳明確錯誤訊息「委託數量必須為 1000 股的整數倍」
4. **Given** 使用者輸入委託資訊，**When** 使用者輸入無效的股票代號或非數字價格，**Then** 系統回傳明確的欄位驗證錯誤訊息
5. **Given** 使用者選擇賣出，**When** 使用者未指定數量或股票代號，**Then** 系統回傳「缺少必要欄位」錯誤訊息
6. **Given** 委託單建立成功，**When** 系統儲存委託單資料，**Then** 系統記錄委託單編號、股票代號、買賣別、價格、數量、交易方式（現股）、委託時間等完整資訊
7. **Given** 使用者嘗試對停牌股票建立委託單，**When** 系統驗證股票狀態，**Then** 系統拒絕建立委託單，並回傳 HTTP 400 狀態碼及「該股票目前停牌或無交易資料」錯誤訊息

**測試說明 - 並發控制驗證**：雖然 MVP 階段的驗收測試著重於單一使用者功能正確性，但並發控制機制（FR-015 定義的 SQL Server SEQUENCE）將在壓力測試階段驗證，使用 k6 模擬 50 並發使用者同時建立委託單，驗證：(1) 所有委託單編號唯一且連續，(2) 無資料庫死鎖或逾時，(3) TPS 達 50 以上。

---

### 使用者故事 4 - 查詢委託單 (優先級: P4)

身為平台使用者，我需要能夠查詢我剛才建立的委託單詳細資訊，以確認委託是否成功及委託內容。

**為何此優先級**: 這是委託單管理的基礎功能，必須在 P3 委託單建立功能完成後才有意義。

**獨立測試**: 在 P3 完成後，可獨立測試委託單查詢功能，透過委託單編號查詢並驗證回傳資訊的完整性和正確性。

**驗收情境**:

1. **Given** 使用者已成功建立委託單（委託單編號為 "ORD-20260202-001"），**When** 使用者以該委託單編號查詢，**Then** 系統回傳完整委託單資訊（編號、股票代號、股票名稱、買賣別、價格、數量、交易方式、委託時間、委託狀態）
2. **Given** 使用者輸入不存在的委託單編號，**When** 使用者查詢該編號，**Then** 系統回傳「委託單不存在」錯誤訊息
3. **Given** 使用者輸入無效的委託單編號格式，**When** 使用者查詢該編號，**Then** 系統回傳「委託單編號格式錯誤」訊息

---

### 邊界案例

- 當市場非交易時段（如週末、國定假日、非交易時間）時，查詢股票即時資訊將回傳最後一次交易時段的資料，並透過時間戳記標示資料時間，系統不主動偵測或拒絕非交易時段的查詢請求
- 當使用者大量連續查詢股票資訊時，系統將實施速率限制：每個客戶端 IP 位址每秒最多 10 次請求，超過限制時回傳 HTTP 429 (Too Many Requests) 錯誤並提示重試時間
- 當外部第三方 API 回應速度過慢（單次請求超過 5 秒逾時）時，系統將自動重試兩次，重試間隔採用指數退避策略（第一次重試等待 1 秒，第二次重試等待 2 秒），若三次嘗試均失敗則回傳明確錯誤訊息並記錄日誌
- 當股票發生暫停交易（如重大訊息暫停）時，委託單建立功能如何回應？
- 當使用者輸入的委託價格剛好等於漲停價或跌停價時，系統是否允許建立委託單？
- 當委託單數量為 0 或負數時，系統如何驗證和回應？
- 當同一時間有多個使用者建立委託單時，系統如何確保委託單編號的唯一性？

## 需求 *(必填)*

### 功能需求

**股票資料管理**:

- **FR-001**: 系統必須預先載入台灣證券交易所股票清單資料（資料來源：TWSE 官網提供的上市公司基本資料 CSV 檔案 t187ap03_L.csv，更新頻率：應用程式啟動時自動載入，手動更新由管理員執行資料庫遷移）
- **FR-002**: 系統必須儲存股票資訊，包含：公司代號、公司名稱、公司簡稱
- **FR-003**: 系統必須提供股票代號查詢功能，支援精確代號查詢（MVP 階段暫不實作關鍵字模糊查詢，僅支援完整股票代號查詢）

**股票即時資訊查詢**:

- **FR-004**: 系統必須提供單一股票即時資訊查詢功能
- **FR-005**: 系統必須在查詢股票即時資訊前驗證股票代號是否存在
- **FR-006**: 系統必須透過台灣證券交易所官方即時報價 API 取得即時股票資訊
- **FR-007**: 系統必須回傳完整的股票即時資訊，包含：
  - 股票識別資訊：股票代號、股票名稱、股票全名
  - 價格資訊：最新成交價、開盤價、最高價、最低價、昨收價
  - 成交量資訊：當日累積成交量、單量成交量
  - 限價資訊：漲停價、跌停價
  - 五檔買賣資訊：五檔買價和買量、五檔賣價和賣量
  - 時間資訊：資料時間戳記、日期、時間
- **FR-008**: 系統必須處理外部資料來源呼叫失敗情況（如逾時、伺服器錯誤），實施重試機制：單次請求逾時設定為 2 秒，失敗時自動重試兩次（重試間隔採指數退避 1 秒、2 秒），三次嘗試均失敗後回傳明確錯誤訊息並記錄詳細日誌（必須包含：時間戳記、股票代號、錯誤類型、重試次數、回應時間、錯誤訊息）。最壞情況總耗時為 9 秒（2秒×3次 + 1秒+2秒退避）

**委託單建立**:

- **FR-009**: 系統必須提供建立委託單功能
- **FR-010**: 系統必須接收以下委託單參數：股票代號、買賣別（買進/賣出）、價格、數量、交易方式（現股）
- **FR-011**: 系統必須驗證股票代號存在
- **FR-012**: 系統必須驗證委託價格在該股票的當日漲跌停範圍內（允許委託價格等於漲停價或跌停價）
- **FR-013**: 系統必須驗證委託數量為整股交易（1000 股的整數倍）
- **FR-014**: 系統必須驗證所有必填欄位（股票代號、買賣別、價格、數量）
- **FR-015**: 系統必須產生唯一的委託單編號，格式為 ORD-YYYYMMDD-{序號}（例如：ORD-20260202-000001），其中序號由資料庫序列（seq_OrderSequence）產生以確保唯一性。併發控制機制：使用 SQL Server SEQUENCE 物件確保多個並發請求產生的序號不會重複，序列設定為 INCREMENT BY 1、START WITH 1、NO CACHE，每次產生新委託單時透過 NEXT VALUE FOR seq_OrderSequence 取得唯一序號
- **FR-016**: 系統必須儲存委託單資訊，包含：委託單編號、股票代號、買賣別、價格、數量、交易方式、委託時間、委託狀態
- **FR-017**: 系統必須回傳委託單建立成功訊息及委託單編號，或回傳明確的錯誤訊息

**委託單查詢**:

- **FR-018**: 系統必須提供查詢委託單功能
- **FR-019**: 系統必須根據委託單編號查詢並回傳完整委託單資訊
- **FR-020**: 系統必須在委託單不存在時回傳明確錯誤訊息

**錯誤處理**:

- **FR-021**: 系統必須對所有輸入參數進行資料型別驗證（如價格為數字、代號為字串）
- **FR-022**: 系統必須提供明確且使用者友善的錯誤訊息，不得暴露技術細節
- **FR-023**: 系統必須記錄所有 API 呼叫錯誤和外部 API 呼叫失敗的日誌
- **FR-024**: 系統必須實施 API 速率限制，每個客戶端 IP 位址每秒最多允許 10 次請求，超過限制時回傳 HTTP 429 狀態碼及重試建議時間（透過 Retry-After header 提供，值為速率限制視窗重置前的剩餘秒數）。備註：MVP 階段採用 per-IP 限制，同一 NAT/Proxy 後的多個使用者共享相同限制額度，未來版本可考慮引入使用者認證後改為 per-user 限制
- **FR-025**: 系統必須處理資料庫連線失敗、ORM 異常等基礎設施錯誤，回傳 HTTP 503 (Service Unavailable) 狀態碼及使用者友善錯誤訊息「系統暫時無法處理您的請求，請稍後再試」，並記錄詳細技術錯誤日誌（包含：時間戳記、錯誤類型、堆疊追蹤、資料庫連線狀態）
- **FR-026**: 系統必須處理停牌股票情境，當查詢停牌股票即時資訊時回傳「該股票目前停牌或無交易資料」訊息，當嘗試對停牌股票建立委託單時拒絕請求並回傳相同訊息及 HTTP 400 狀態碼

**錯誤訊息撰寫規範**：

所有使用者可見的錯誤訊息必須遵循以下規範：

1. **語言要求**：一律使用繁體中文，不得包含英文技術術語（如 "null pointer exception"）
2. **明確性**：明確說明問題原因，避免模糊的描述（✖ 「發生錯誤」 → ✓ 「股票代號不存在」）
3. **友善性**：使用禮貌、尊重的語氣，避免指責使用者（✖ 「你輸入錯誤」 → ✓ 「請確認輸入格式」）
4. **可行動指引**：盡可能提供具體的修正建議（✖ 「格式不正確」 → ✓ 「股票代號必須為 4 位數字，如 2330」）
5. **簡潔性**：保持訊息簡潔，一般不超過 30 字，複雜情境不超過 50 字
6. **統一格式**：所有錯誤訊息結尾不加句號，不使用驚嘆號
7. **隱藏技術細節**：不暴露資料庫錯誤、堆疊追蹤、內部路徑、API 端點等技術資訊

**範例**：
- ✓ 「股票代號不存在」
- ✓ 「價格超出漲跌停範圍，請調整為 800 元至 1000 元之間」
- ✓ 「委託數量必須為 1000 股的整數倍」
- ✓ 「系統暫時無法處理您的請求，請稍後再試」
- ✖ 「Database connection timeout exception」
- ✖ 「你輸入的東西不對！」

**明確排除的功能（第一版 MVP 不實作）**:

- 不實作委託單刪除或修改功能
- 不實作融資、融券交易方式
- 不實作 IOC（立即成交否則取消）、FOK（全部成交否則取消）委託類型
- 不實作零股交易（僅支援整股交易）
- 不實作會員機制和使用者認證
- 不實作 API 安全機制（如 Token 驗證）
- 不實作持倉管理邏輯（LIFO、加權平均成本法、指定批次）
- 不實作資料庫備份、防災演練
- 不實作監控與效能指標追蹤

**API 版本控制策略**:

- API 路徑包含版本號：`/api/v1/...`
- 版本命名規則：主版本號（v1, v2, v3...），不使用次版本號
- 版本變更時機：
  - 破壞性變更（Breaking Changes）：必須升級主版本號
  - 非破壞性變更（如新增欄位、新增端點）：不升級版本號
- 版本支援政策：
  - MVP 階段僅維護單一版本（v1）
  - 未來版本發布後，舊版本支援至少 6 個月
  - 版本棄用前 3 個月透過 API 回應 Header 提供警告（`X-API-Deprecated: true`, `X-API-Sunset: 2026-12-31`）
- 向後相容原則：
  - 新增回應欄位不視為破壞性變更
  - 新增選填請求參數不視為破壞性變更
  - 修改或刪除現有欄位視為破壞性變更

### 關鍵實體

- **Stock（股票）**: 代表台灣證券交易所上市股票，包含公司代號、公司名稱、公司簡稱
- **Order（委託單）**: 代表使用者建立的股票買賣委託，包含委託單編號、股票代號、買賣別、價格、數量、交易方式、委託時間、委託狀態（固定為「已委託」），與股票資訊關聯。MVP 版本不支持狀態變更，所有委託單建立後狀態恆保持為「已委託」

## 成功標準 *(必填)*

### 可衡量結果

- **SC-001**: 使用者可在 1 秒內完成股票代號查詢並取得結果
- **SC-002**: 使用者可在正常情況下 3 秒內完成單一股票即時資訊查詢（包含外部 API 呼叫時間）。在最壞情況下（包含所有重試嘗試），查詢時間可能延長至 9 秒
- **SC-003**: 使用者可在 2 秒內完成委託單建立並取得委託單編號
- **SC-004**: 系統在委託單建立時，能 100% 攔截超出漲跌停範圍的委託價格
- **SC-005**: 系統能正確顯示所有錯誤情境的明確錯誤訊息，使用者無需技術知識即可理解錯誤原因
- **SC-006**: 系統能穩定處理外部 API 呼叫失敗情況，不會導致系統崩潰或無回應
- **SC-007**: 90% 的使用者能在第一次嘗試時成功完成股票查詢和委託單建立流程
- **SC-008**: 委託單編號生成機制能確保 100% 唯一性，不會有重複編號

## 假設

- 假設台灣證券交易所公開資料介面在交易時段內可穩定存取，回應時間通常在 1-2 秒內
- 假設使用者輸入的股票代號格式為台灣證券交易所標準格式（4 位數字）
- 假設整股交易單位固定為 1000 股（1 張）
- 假設委託單建立後的初始狀態為「已委託」，但本階段不處理委託單後續的撮合、成交、取消等狀態變更
- 假設第一版 MVP 僅支援現股買賣，不考慮其他交易方式
- 假設系統在市場非交易時段（週末、國定假日、非交易時間）仍可查詢股票資訊，但回傳的是最後交易時段的資料並標示時間戳記，系統不主動偵測或限制非交易時段的查詢
- 假設委託價格可以等於漲停價或跌停價（不會被拒絕）
- 假設所有日期時間使用台北時區（UTC+8）
- 假設系統使用者已了解股票交易基本概念，無需提供教學或說明功能
## Clarifications

### Session 2026-02-02

- Q: The spec mentions storing Stock and Order entities but doesn't specify the persistence mechanism. This affects data modeling, transaction handling, recovery strategies, and deployment architecture. → A: Relational database (MS SQL Server) with ORM
- Q: The spec mentions calling "台灣證券交易所公開資料介面" but doesn't specify which API/protocol. This affects integration implementation, data parsing, error handling, rate limiting, and testing strategy. → A: TWSE official real-time quote API
- Q: The spec mentions rate limiting as a boundary case but doesn't specify the rate limit policy. This affects API design, infrastructure sizing, user experience, and operational monitoring. → A: 10 requests/second per client IP
- Q: The spec mentions timeout handling for external API calls but doesn't specify retry behavior. This affects reliability, user experience during transient failures, and operational cost. → A: Retry twice with exponential backoff (1s, 2s)
- Q: The spec defines order statuses but only mentions "已委託" (submitted). For proper order tracking, the complete status lifecycle needs definition. → A: Single status only ("已委託")
- Q: The spec mentions timeout handling for external API calls but doesn't specify retry behavior. This affects reliability, user experience during transient failures, and operational cost. → A: Retry twice with exponential backoff (1s, 2s)
## 依賴性

- 依賴台灣證券交易所官方即時報價 API 的可用性和穩定性，以取得即時股票交易資訊，需考慮該服務的 API 速率限制和服務條款
- 依賴台灣證券交易所提供的股票清單資料來源
- 依賴 Microsoft SQL Server 關聯式資料庫系統以持久化股票和委託單資料,需透過 ORM (Object-Relational Mapping) 框架進行資料存取,確保 ACID 交易特性以維護金融資料完整性
