# 功能規格：證券交易資料查詢系統

**功能分支**: `001-securities-trading-api`  
**建立日期**: 2026年2月2日  
**狀態**: 草稿  
**輸入**: 使用者描述：「請實作一個『證券交易資料查詢系統』RESTful API，包含股票查詢、下單、委託查詢等功能」

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - 查詢即時股票資訊 (優先級：P1)

交易者和投資者需要查詢個別股票（例如台積電 - 2330.tw）的即時股價和詳細資訊，以做出明智的交易決策。系統從外部來源擷取目前市場數據，包括價格、成交量、最高/最低價值以及其他交易指標。

**為何此優先級**：這是交易系統的基礎。如果無法查看股票資訊，使用者就無法做出任何交易決策。這提供了即時價值，並可以獨立部署。

**獨立測試**：可以透過查詢股票代碼（例如 2330）並驗證返回的當前市場數據包含所有必要欄位（價格、成交量、時間等），為使用者提供即時市場可見性，來進行完整測試。

**驗收情境**：

1. **假設** 使用者想要查看台積電股票，**當** 他們查詢股票代碼「2330」時，**則** 系統返回即時價格、成交量、最高/最低價值和時間戳記
2. **假設** 使用者查詢有效的股票代碼，**當** 請求在交易時段內進行時，**則** 回應包含在最近 5 秒內更新的當前交易數據
3. **假設** 使用者查詢無效的股票代碼，**當** 處理請求時，**則** 系統返回清楚的錯誤訊息，指出找不到該股票
4. **假設** 外部資料來源不可用，**當** 使用者查詢股票資訊時，**則** 系統在重試後返回快取資料（如果可用）並附上過時警告（如果資料超過 30 秒），或在沒有快取資料時返回服務不可用錯誤

---

### 使用者故事 2 - 瀏覽和搜尋股票目錄 (優先級：P1)

使用者需要瀏覽可用的股票並按代碼或關鍵字（公司名稱）搜尋，以發現交易機會並找到他們想要追蹤或交易的特定證券。系統提供分頁結果以有效處理大型資料集。

**為何此優先級**：對於發現和導航至關重要。使用者必須能夠找到股票，然後才能查詢或交易它們。這補充了故事 1，兩者一起構成了唯讀市場數據存取的最小可行產品。

**獨立測試**：可以透過使用分頁參數檢索股票清單、按關鍵字/代碼篩選，並驗證正確的資料結構和分頁行為，提供可瀏覽的可用證券目錄，來進行完整測試。

**驗收情境**：

1. **假設** 使用者想要查看可用的股票，**當** 他們請求沒有篩選條件的股票清單時，**則** 系統返回所有股票的分頁清單，預設頁面大小為 20
2. **假設** 使用者搜尋「台積」（部分公司名稱），**當** 執行搜尋時，**則** 系統返回公司名稱中符合關鍵字的所有股票
3. **假設** 使用者按代碼「2330」搜尋，**當** 執行搜尋時，**則** 系統返回代碼為 2330 的符合股票
4. **假設** 使用者請求第 3 頁，頁面大小為 50，**當** 處理請求時，**則** 系統返回記錄 101-150（如果可用）
5. **假設** 使用者請求超出可用資料的頁面，**當** 處理請求時，**則** 系統返回空的結果集及適當的元數據

---

### 使用者故事 3 - 下達買入/賣出委託單 (優先級：P2)

交易者需要為特定股票建立買入或賣出委託單，以所需的價格和數量執行其交易策略。每個委託單都會捕捉交易者的意圖（買入/賣出）、目標證券、價格限制和數量。

**為何此優先級**：這是將交易系統與唯讀市場數據檢視器區分開來的核心交易功能。它依賴於故事 1（了解股價），但可以使用模擬或測試資料進行獨立測試。

**獨立測試**：可以透過提交各種委託單類型（買入/賣出）以及不同的價格和數量參數，驗證委託單建立、驗證規則和委託單確認回應，提供執行交易的能力，來進行完整測試。

**驗收情境**：

1. **假設** 使用者想要以 1780 的價格購買 1000 股股票 2330，**當** 他們提交買入委託單時，**則** 系統建立委託單並返回唯一的委託單識別碼和確認
2. **假設** 使用者提交數量無效的委託單（例如 0 或負數），**當** 驗證委託單時，**則** 系統拒絕該委託單並顯示清楚的錯誤訊息
3. **假設** 使用者提交價格無效的委託單（例如負數），**當** 驗證委託單時，**則** 系統拒絕該委託單並顯示清楚的錯誤訊息
4. **假設** 使用者為不存在的股票代碼提交委託單，**當** 驗證委託單時，**則** 系統拒絕該委託單並指出找不到該股票
5. **假設** 使用者在收盤時間提交委託單，**當** 處理委託單時，**則** 系統將委託單排入下一個開盤時段的佇列，並顯示適當的狀態

---

### 使用者故事 4 - 追蹤委託單狀態和歷史記錄 (優先級：P2)

使用者需要檢索其提交的委託單詳細資訊，以監控執行狀態、驗證委託單參數，並維護其交易活動記錄。每個委託單都有一個生命週期（待處理、已執行、已取消、已拒絕），使用者需要追蹤。

**為何此優先級**：對於交易的透明度和問責制至關重要。使用者必須能夠確認其委託單已正確接收並監控執行情況。依賴於故事 3，但為委託單管理提供獨立價值。

**獨立測試**：可以透過建立委託單（透過故事 3 或測試資料），然後按委託單 ID 查詢它們，驗證所有委託單詳細資訊都已正確檢索且狀態準確反映，提供委託單透明度，來進行完整測試。

**驗收情境**：

1. **假設** 使用者已下達委託單，**當** 他們使用委託單 ID 查詢時，**則** 系統返回完整的委託單詳細資訊，包括代碼、價格、數量、類型（買入/賣出）、狀態和時間戳記
2. **假設** 使用者查詢不存在的委託單 ID，**當** 處理請求時，**則** 系統返回找不到的錯誤
3. **假設** 使用者查詢其委託單歷史記錄，**當** 按日期範圍篩選時，**則** 系統返回該期間內的所有委託單，按提交時間排序
4. **假設** 委託單狀態發生變化（例如，從待處理變為已執行），**當** 使用者查詢委託單時，**則** 系統反映更新的狀態及狀態變更的時間戳記

---

### 邊緣情況

- **擷取外部市場數據時網路逾時**：系統應實施指數退避重試策略（10 秒內進行 3 次嘗試），然後返回最佳可用資料並附上過時警告。如果沒有可用的快取資料，則返回 HTTP 503 服務不可用錯誤並提供重試指引
- **同一股票的並行委託單**：系統必須使用資料庫交易隔離層級（SERIALIZABLE 或 REPEATABLE READ）來處理同時提交的委託單，確保每個委託單都以原子方式獨立記錄，防止競態條件導致的資料損壞
- **API 請求中的無效資料格式**：系統驗證所有輸入欄位並返回結構化錯誤訊息，指出哪些欄位無效以及原因
- **大型結果集**：系統強制執行最大頁面大小限制（例如，每頁 1000 筆記錄）以防止效能下降
- **缺少欄位的市場數據**：系統優雅地處理來自外部來源的不完整資料，將欄位標記為不可用，而不是使整個請求失敗
- **恰好在收盤時提交委託單**：系統確定截止時間，並接受隔天的委託單或以清楚的說明拒絕
- **重複提交委託單**：系統檢測並處理潛在的重複提交（例如，透過冪等性檢查）以防止意外的多個委託單

## Clarifications

### Session 2026-02-02

- Q: When the Taiwan Stock Exchange API is unavailable and cached data is too stale (beyond the acceptable threshold), how should the system respond to stock queries? → A: Implement exponential backoff retry (3 attempts over 10 seconds) then return best available data with staleness warning
- Q: What is the acceptable staleness threshold for cached stock data before it should trigger a warning to users? → A: 30 seconds
- Q: How should the system handle concurrent order submissions for the same stock to prevent data corruption? → A: Database transaction isolation (SERIALIZABLE/REPEATABLE READ)

## 功能需求 *(必填)*

### 功能需求

#### 股票資料查詢

- **FR-001**: 系統必須提供一個端點來取得所有可用股票的列表，並支援分頁功能
- **FR-002**: 系統必須支援按精確股票代碼進行篩選
- **FR-003**: 系統必須支援按公司名稱進行部分關鍵字匹配篩選
- **FR-004**: 系統必須提供一個端點來按股票代碼取得單一股票的詳細資訊
- **FR-005**: 系統必須從台灣證券交易所 API (https://mis.twse.com.tw/stock/api/getStockInfo.jsp) 取得即時股票資料以供即時市場資訊
- **FR-006**: 系統必須解析並公開以下股票資料欄位：代碼、公司名稱（完整及簡稱）、現價、開盤價、最高價、最低價、成交量、時間戳記、昨日收盤價
- **FR-007**: 系統必須對股票資料進行快取，並具有可配置的存活時間（預設為 30 秒），以減少外部 API 呼叫並改善回應時間。超過 30 秒的快取資料被視為過時
- **FR-008**: 當外部 API 無法存取時，系統必須實施指數退避重試機制（在 10 秒內進行 3 次嘗試，間隔時間為 1 秒、3 秒、6 秒）。如果所有重試均失敗且快取資料可用（即使超過 30 秒過時閾值），則返回快取資料並在回應中包含資料過時警告、快取時間戳記和資料年齡。如果沒有可用的快取資料，則返回 HTTP 503 服務不可用錯誤

#### 委託單管理

- **FR-009**: 系統必須提供一個端點來建立新的交易委託單，參數包括：委託單類型（買入/賣出）、股票代碼、價格、數量
- **FR-010**: 系統必須在接受委託單之前驗證股票代碼存在
- **FR-011**: 系統必須驗證委託單數量是正整數
- **FR-012**: 系統必須驗證委託單價格是正小數
- **FR-013**: 系統必須為每個建立的委託單指派唯一的委託單識別碼
- **FR-014**: 系統必須記錄委託單建立的時間戳記
- **FR-015**: 系統必須提供一個端點來按委託單識別碼取得委託單詳細資訊
- **FR-016**: 系統必須追蹤委託單生命週期內的狀態（待處理、已執行、已取消、已拒絕、已過期）
- **FR-017**: 系統必須使用資料庫交易隔離層級（SERIALIZABLE 或 REPEATABLE READ）來處理並行委託單建立，確保每個委託單以原子方式記錄並防止競態條件
- **FR-018**: 系統必須持久化保存所有委託單資料以防止資料遺失

#### 資料管理

- **FR-019**: 系統必須維護可用股票的永久性目錄，包括代碼和公司名稱
- **FR-020**: 系統必須按存取模式分類資料儲存（熱資料：即時價格；暖資料：最近委託單；冷資料：歷史記錄）
- **FR-021**: 系統必須支援分開的讀寫操作以啟用效能最佳化

#### API 標準

- **FR-022**: 系統必須通過 RESTful HTTP 端點公開所有功能，遵循標準慣例（GET 用於查詢，POST 用於建立）
- **FR-023**: 系統必須以 JSON 格式返回回應
- **FR-024**: 系統必須使用標準 HTTP 狀態碼（200 表示成功，400 表示客戶端錯誤，404 表示找不到，500 表示伺服器錯誤）
- **FR-025**: 系統必須提供結構化的錯誤回應，包括錯誤代碼和易讀的訊息
- **FR-026**: 系統必須通過互動式文件介面支援 API 文件
- **FR-027**: 系統必須驗證所有傳入的請求有效負載並返回詳細的驗證錯誤

#### 效能和可靠性

- **FR-028**: 系統必須能夠處理至少 100 個併發使用者請求而不會出現明顯的效能降低
- **FR-029**: 系統必須為所有 API 呼叫實作請求日誌記錄，包括請求參數、回應狀態和執行時間
- **FR-030**: 系統必須為所有系統故障和例外實作錯誤日誌記錄
- **FR-031**: 系統必須提供健康檢查端點以監控系統可用性

### 關鍵實體 *(如果功能涉及資料，則包括)*

- **股票**: 代表可交易的證券，屬性包括股票代碼（唯一識別碼）、公司完整名稱、簡稱、交易所（例如 TSE - 台灣證券交易所）和目前上市狀態
- **即時報價**: 代表股票的目前市場資料，包括現價、開盤價、當日最高/最低價、成交量、買/賣價、最後更新時間戳記和昨日收盤價以供比較
- **委託單**: 代表使用者提交的交易指令，屬性包括唯一委託單 ID、股票代碼參考、委託單類型（買入/賣出）、要求的價格、股數、委託單狀態（待處理/已執行/已取消/已拒絕/已過期）、提交時間戳記和最後更新時間戳記
- **委託單歷史**: 與追蹤和審計相關的委託單集合，可按日期範圍、狀態和股票代碼進行篩選

## 成功標準 *(必填)*

### 可測量的成果

- **SC-001**: 使用者可在正常市場條件下於請求提交後 2 秒內取得即時股票資訊
- **SC-002**: 系統支援至少 100 個併發使用者查詢股票資料，回應時間不超過 2 秒
- **SC-003**: 股票列表分頁功能允許使用者有效瀏覽至少 1,000 支股票，可配置的頁面大小最高為 100 筆記錄
- **SC-004**: 使用者可在 1 秒內提交並收到買入/賣出委託單的確認
- **SC-005**: 訂單驗證捕捉並報告 100% 的無效輸入（無效代碼、負數量、負價格），在建立訂單前
- **SC-006**: 系統在市場時段內（台灣時間上午 9:00 - 下午 1:30）維持 99.9% 的正常運行時間
- **SC-007**: 所有 API 操作在 50 個併發使用者負載下於第 90 個百分位數時在 500 毫秒內返回回應
- **SC-008**: 系統成功處理模擬 100 個併發使用者在 2 分鐘內發出請求的負載測試，錯誤率低於 1%
- **SC-009**: API 文件允許開發人員在 1 小時內成功與所有端點整合
- **SC-010**: 95% 的使用者在首次嘗試時成功完成第一次股票查詢而無錯誤
- **SC-011**: 系統記錄 100% 的所有 API 請求和錯誤用於除錯和審計目的
- **SC-012**: 快取的股票資料在高流量期間將外部 API 呼叫減少至少 80%，同時在 5 秒內維持資料新鮮度

## 假設 *(必填)*

### 技術假設

- **A-001**: 系統將部署在具有可靠網際網路連接的環境中以存取台灣證券交易所 API
- **A-002**: 台灣證券交易所 API 保持可用並維持目前的回應格式
- **A-003**: 台灣證券交易所 API 的股票資料在市場時段內至少每 5 秒更新一次
- **A-004**: 第 1 階段的記憶體內快取就足夠；計劃在未來的可擴展性遷移中改用分散式快取

### 商業假設

- **A-005**: 交易時間遵循台灣證券交易所時間表（目前為工作日上午 9:00 - 下午 1:30）
- **A-006**: 初期部署目標是個人交易者和小型交易公司（非高頻交易）
- **A-007**: 委託單提交不包括實際的訂單執行或結算 - 此系統只記錄交易意圖
- **A-008**: 使用者驗證和授權將在未來階段新增 - 第 1 階段著重於核心功能
- **A-009**: 初期目錄只包括台灣證券交易所的股票；其他交易所可能稍後新增
- **A-010**: 委託單被記錄用於追蹤目的；與經紀商/交易所的實際執行超出此階段的範圍

### 資料假設

- **A-011**: 股票代碼遵循台灣證券交易所格式（4 位數代碼，如 "2330"）
- **A-012**: 價格值使用台灣幣（TWD）
- **A-013**: 股票數量以"股"計量，最小一手為 1 股（系統初期不會強制一手限制）
- **A-014**: 90 天的歷史資料保留期對初期部署而言就足夠；如需要可配置較長的保留期

## 限制 *(必填)*

### 外部依賴

- **C-001**: 系統依賴台灣證券交易所即時資料 API (https://mis.twse.com.tw/stock/api/getStockInfo.jsp) 獲取目前市場價格
- **C-002**: 外部 API 具有 5000 毫秒（5 秒）的使用者延遲（如回應所示），可能影響資料新鮮度保證
- **C-003**: 外部 API 的可用性和效能超出系統控制範圍，可能影響系統的回應能力

### 範圍邊界

- **C-004**: 第 1 階段不包括使用者驗證和授權 - 所有端點公開存取
- **C-005**: 第 1 階段不包括與經紀商或交易所的實際交易執行 - 系統只記錄委託單
- **C-006**: 第 1 階段不包括投資組合管理、損益計算和帳戶餘額追蹤
- **C-007**: 第 1 階段不包括即時價格警報和通知
- **C-008**: 第 1 階段不包括委託單修改或取消功能
- **C-009**: 系統僅聚焦台灣證券交易所；其他交易所超出範圍

### 效能邊界

- **C-010**: 初期部署目標支援至多 100 個併發使用者；超出此範圍的擴展需要建築審查
- **C-011**: 記憶體內快取的大小受限於可用伺服器記憶體；大型股票目錄可能需要快取驅逐策略
- **C-012**: 回應時間取決於外部 API 效能和網路延遲

### 合規和安全

- **C-013**: 第 1 階段不處理個人財務資料或執行實際交易，減少直接的監管合規要求
- **C-014**: 系統必須記錄所有操作以供未來合規要求新增時的審計追蹤
- **C-015**: 在未來階段處理使用者帳戶之前，必須定義資料保留和隱私政策

## 第 1 階段交付物 *(必填)*

### 核心 API 端點

1. **GET /api/v1/stocks** - 取得股票的分頁列表，支援按代碼和關鍵字的可選篩選
2. **GET /api/v1/stocks/{symbol}** - 取得特定股票的詳細即時資訊
3. **POST /api/v1/orders** - 提交新的買入或賣出委託單
4. **GET /api/v1/orders/{id}** - 取得特定委託單的詳細資訊

### 品質需求

- **請求驗證** 使用驗證框架在處理前捕捉無效輸入
- **標準化錯誤回應** 具有一致格式，包括錯誤碼、訊息和驗證錯誤的欄位層級詳細資訊
- **記憶體內快取** 用於股票資料，具有可配置的存活時間
- **全面的日誌記錄** 所有請求、回應和錯誤的結構化日誌格式
- **單元測試覆蓋率** 所有業務邏輯元件的 100% 覆蓋率
- **API 文件** 具有互動式介面用於測試端點
- **標準化回應格式** 通過中間件/篩選器實現跨所有端點的一致回應

### 測試需求

- **單元測試** 涵蓋所有驗證邏輯、業務規則和資料轉換，目標 100% 程式碼覆蓋率
- **整合測試** 驗證端到端 API 工作流，包括外部 API 互動（使用模擬的外部依賴以提高可靠性）
- **負載測試** 使用專門的負載測試工具驗證系統能處理 100 個併發使用者，回應時間低於 1 秒，錯誤率低於 1%
- **壓力測試** 識別斷裂點並確保在極端負載下的優雅降級

### 文件交付物

- **API 文件** 可通過互動式文件端點存取
- **設定和部署指南** 用於在開發和生產環境中執行系統
- **建築文件** 描述分層建築、CQRS 分隔和快取策略
- **測試指南** 包含執行單元測試、整合測試和負載測試的說明
- **資料庫架構文件** 描述所有表、關係和索引

## 第 2 階段考量 *(選擇)*

### 未來增強（超出第 1 階段範圍）

- **使用者驗證和授權**: 實作使用者帳戶、基於角色的存取控制和 API 令牌管理
- **委託單管理延伸**: 新增修改待處理委託單、取消委託單和追蹤委託單執行歷史的能力
- **投資組合管理**: 追蹤使用者持股、計算損益和提供投資組合分析
- **進階搜尋**: 新增市場資本額、產業、價格範圍、成交量門檻的篩選
- **即時通知**: 通過 Webhooks 或 WebSockets 實作價格警報和委託單執行通知
- **分散式快取**: 從記憶體內快取遷移至分散式快取（Redis）以進行水平擴展
- **速率限制**: 實作每使用者速率限制以防止濫用並確保公平使用
- **批量操作**: 支援大量委託單提交和大量股票查詢
- **市場資料歷史**: 儲存並提供歷史價格資料和圖表的存取
- **交易分析**: 提供交易模式、熱門股票和市場趨勢的見解
- **行動 API 最佳化**: 最佳化端點供行動應用程式使用，減少有效負載大小
- **多交易所支援**: 延伸支援台灣證券交易所以外的其他交易所的股票

### 可擴展性路徑

- 遷移至分散式快取基礎設施以處理更大使用者群
- 資料庫讀取副本配置以擴展讀取操作
- 事件驅動建築用於委託單處理和通知
- API 閘道實作用於負載平衡和速率限制

### 效能測試進展

- 作為 CI/CD 管道的一部分進行持續負載測試
- 壓力測試場景模擬 500+ 個併發使用者
- 混沌工程測試以驗證在故障條件下的恢復能力
- 針對交易系統行業標準的效能基準測試
